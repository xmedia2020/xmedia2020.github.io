<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Prova Safari Server 2</title>
</head>
<body>
    <audio id="audio" src="commento.mp3"></audio>
    <canvas id="canvas" style="background-color:gray;width:512px; height:256px;"></canvas>
    <button>BUTTON</button>
    <script type="text/javascript">

        window.AudioContext = window.AudioContext || window.webkitAudioContext

        const sound = document.getElementById("audio")
        const audioContext = new AudioContext()

        const audioSourceNode = audioContext.createMediaElementSource(sound)


        sound.addEventListener("loadedmetadata", e => console.log("1. loadedmetadata"))
        sound.addEventListener("loadeddata", e => console.log("2. loadeddata"))
        sound.addEventListener("canplay", e => console.log("3. canplay"))
        sound.addEventListener("play", e => {
            requestAnimationFrame(render);
            console.log("4. play")
        })
        sound.addEventListener("ended", e => console.log("5. ended"))



        const analyser = audioContext.createAnalyser()
        analyser.fftSize = 256
        audioSourceNode.connect(analyser)
        analyser.connect(audioContext.destination)


        document.querySelector("button").onclick = function(){
            sound.play()
        }

        const canvas = document.getElementById('canvas')
        const canvasCtx = canvas.getContext("2d")
        function render() {
            let data = new Uint8Array(analyser.frequencyBinCount)
            analyser.getByteTimeDomainData(data)
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height)
            for (let i=0; i<data.length; i++) {
                canvasCtx.fillStyle = "black";
                canvasCtx.fillRect(i, 0, 1, data[i]);
            }
            requestAnimationFrame(render);
        }

    </script>
</body>
</html>