<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <title>Prova Safari Server 1</title>
</head>
<body>
    <!-- <audio id="audio" src="commento.mp3"></audio> -->
    <canvas id="canvas" style="width:512px; height:256px;"></canvas>
    <br>
    <button>PLAY 18</button>
    <script type="text/javascript">
        window.AudioContext = window.AudioContext || window.webkitAudioContext

        const AUDIO_FILE = 'commento.mp3'
        const player = new Audio(AUDIO_FILE)
        player.load()   // This will trigger all sound events... so we can't use sound listeners

        // const player = document.getElementById("audio")
        const audio_ctx = new AudioContext()
        let analyser

        let __once__ = false

        document.querySelector("button").onclick = function(){
            if(!__once__) {
                                // QUIRK: analyser MUST be created after .load() for Safari...!
                analyser = audio_ctx.createAnalyser()
                analyser.connect(audio_ctx.destination)

                const audio_src = audio_ctx.createMediaElementSource(player)
                audio_src.connect(analyser)

                __once__ = true
                requestAnimationFrame(render);
            }
            player.currentTime = 0
            player.play()
        }

        const canvas = document.getElementById('canvas')
        const ctx = canvas.getContext("2d")

        canvas.width = 512
        canvas.height = 256
        function render() {

            let data = new Uint8Array(analyser.frequencyBinCount)
            analyser.getByteTimeDomainData(data)

            ctx.clearRect(0, 0, canvas.width, canvas.height)
            for (let i=0; i<data.length; i++) {
                ctx.fillStyle = "black";
                ctx.fillRect(i*2, 128, 1, (data[i]-128)*2);
            }

            requestAnimationFrame(render);
        }

    </script>

</body></html>